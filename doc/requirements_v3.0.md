# View Pic - 项目结构重构需求文档 v3.0

## 版本信息

- **版本**: v3.0.0  
- **创建日期**: 2026-01-11  
- **迭代主题**: 项目结构重构与模块化  
- **基于版本**: v2.0.0

---

## 项目概述

本次迭代（v3.0）聚焦于在**不改变现有功能行为和用户体验的前提下**，对项目代码结构进行标准化和模块化重构，使其更贴近企业级 Python 项目结构，提升可维护性、可扩展性与可测试性。

现状：当前所有核心逻辑集中在单个 `main.py` 文件中（约 600 行），包括：
- **UI 布局**（窗口、左右布局、工具栏、预览对话框）
- **业务逻辑**（图片扫描、列表/网格展示、预览、键盘交互）
- **基础服务**（缩略图生成、文件系统访问、移动设备监听）
- **应用入口**（`ft.run(app.main)` + `if __name__ == "__main__": main()`）

问题：
- 模块职责耦合严重，理解和修改成本较高
- 无法按功能模块进行单元测试或重用逻辑
- 新功能（如后续 v2.1/v2.2 计划）接入成本高

目标：通过合理的目录划分和模块拆分，形成**清晰的分层结构**，为后续功能演进（缩放、全屏、幻灯片等）打好基础。

---

## 三期核心需求

### 1. 目录结构标准化

#### 1.1 目标目录结构（初版）

在现有仓库根目录基础上，将代码重构为如下结构：

```bash
view_pic/
├── src/                      # 核心代码包（新增）
│   ├── __init__.py
│   ├── app.py                # 应用入口 & 组装层（ImageViewerApp 定义）
│   ├── config/               # 配置相关模块
│   │   ├── __init__.py
│   │   └── settings.py       # 常量配置（支持的格式、路径、颜色等）
│   ├── core/                 # 核心业务逻辑（按领域拆分）
│   │   ├── __init__.py
│   │   ├── file_browser.py   # 文件夹树与文件夹加载逻辑
│   │   ├── image_gallery.py  # 图片列表/网格展示与视图模式切换
│   │   └── preview.py        # 大图预览、缩略图轮播、键盘切换
│   ├── services/             # 后端服务类（与 UI 相对独立）
│   │   ├── __init__.py
│   │   ├── image_service.py  # 图片加载、缩略图生成、缓存
│   │   └── device_service.py # 移动设备扫描与监听
│   ├── utils/                # 通用工具函数
│   │   ├── __init__.py
│   │   └── fs_utils.py       # 文件系统辅助方法、路径工具
│   └── resources/            # 静态资源（预留）
│       └── .gitkeep          # 占位文件（如需）
│
├── tests/                    # 测试目录（预留结构）
│   ├── __init__.py
│   ├── test_core/
│   └── test_services/
│
├── scripts/                  # 辅助脚本目录（预留）
│   ├── __init__.py
│   └── dev_run.py            # 本地开发运行脚本（可选）
│
├── doc/                      # 文档目录（已存在）
│   ├── requirements.md
│   ├── requirements_v2.0.md
│   ├── requirements_v3.0.md  # ⭐ 本次新增
│   ├── implementation_v1.0.md
│   ├── implementation_v2.0.md
│   └── user_guide.md
│
├── main.py                   # 启动脚本（保留，内部变为薄封装）
├── pyproject.toml
└── README.md
```

> 说明：以上为目标结构，落地时会优先完成与当前功能直接相关的模块拆分（`view_pic/app.py`、`core/*`、`services/*`、`config/settings.py`）。`tests/` 与 `scripts/` 目录可先建立占位，后续迭代逐步补充。

---

### 2. 分层与模块职责定义

#### 2.1 应用入口层

- **文件**: `main.py`（根目录） + `src/app.py`
- **职责**:
  - `main.py`:
    - 作为命令行启动入口，保留当前用户使用方式：`uv run python main.py`
    - 仅负责创建应用实例并调用 Flet 运行函数（薄封装，不再承载业务逻辑）
  - `view_pic/app.py`:
    - 定义 `ImageViewerApp` 主类
    - 负责组装 UI 与业务模块（依赖 `core` 和 `services`）
    - 暴露 `main(page: ft.Page)` 供 `ft.run()` 使用

#### 2.2 配置层（config）

- **文件**: `src/config/settings.py`
- **内容示例**（具体实现阶段再细化）：
  - 支持的图片格式：`SUPPORTED_IMAGE_FORMATS = (".jpg", ".jpeg", ".png", ".gif")`
  - 默认路径：`VOLUMES_PATH`、`HOME_PATH` 等
  - UI 相关常量（颜色、尺寸、间距），例如：
    - 主色、背景色、边框色
    - 窗口默认大小、最小大小
- **目标**:
  - 将当前 `ImageViewerApp.__init__` 中的硬编码常量迁移至配置模块
  - 为后续支持多环境配置（如开发/测试）预留扩展点

#### 2.3 核心业务层（core）

- **文件**: `src/core/file_browser.py`
  - 职责：
    - 封装文件夹树的构建逻辑（常用位置、移动设备区占位）
    - 提供创建文件夹项的 UI 组件工厂
    - 对 `ImageViewerApp` 暴露：
      - `build_folder_tree(app)` / `create_folder_item(...)` 等方法

- **文件**: `src/core/image_gallery.py`
  - 职责：
    - 图片列表/网格视图的 UI 构建
    - 视图模式切换逻辑（`grid` / `list`）
    - 与 `image_service` 协作，获取图片及其元数据

- **文件**: `src/core/preview.py`
  - 职责：
    - 大图预览对话框 UI（包含关闭按钮、左右切换按钮、位置指示器、底部缩略图）
    - 图片切换、循环浏览、缩略图高亮等交互逻辑
    - 键盘事件处理入口（可与 `app.py` 中的 `on_keyboard_event` 协作或下沉）

> 约束：`core` 层尽量只关心“业务和界面布局”，具体 IO、线程、图片处理等由 `services` 层承载。

#### 2.4 服务层（services）

- **文件**: `src/services/image_service.py`
  - 职责：
    - 图片扫描：给定文件夹路径，返回图片列表（`Path` 列表）
    - 缩略图生成：封装 `Pillow` 调用，生成 base64 data URI
    - 图片预览加载：负责将原图转换为可在 Flet 中展示的 src 字符串
    - 后续可以扩展缓存策略、懒加载等逻辑

- **文件**: `src/services/device_service.py`
  - 职责：
    - 封装 `/Volumes` 目录扫描逻辑
    - 提供获取当前设备列表的接口
    - 封装设备监听线程逻辑（开始/停止监控）

> 约束：`services` 层不依赖具体 UI 组件，方便后续编写单元测试。

#### 2.5 工具层（utils）

- **文件**: `src/utils/fs_utils.py`
  - 职责：
    - 通用文件系统工具方法，例如：
      - 安全列目录（带异常处理）
      - 提取文件大小、格式化显示（MB 文本）
      - 过滤符合指定扩展名的文件
  - 将当前 `main.py` 中可复用的小逻辑抽取至此，减少重复。

#### 2.6 资源层（resources）

- **文件**: `src/resources/`
  - 职责：
    - 存放后续可能使用的图标、示例图片、国际化文案等
  - 当前版本可仅创建目录（如需，可添加占位文件），不强制引入实际资源。

#### 2.7 测试与脚本层

- **tests/**:
  - 初期主要建立目录与命名约定：
    - `tests/test_core/` 对应核心业务模块
    - `tests/test_services/` 对应服务层模块
  - 本次迭代不强制补充完整测试，但在模块拆分时应确保代码结构**易于单元测试**。

- **scripts/**:
  - 预留 `dev_run.py`（可选），封装常用开发启动命令
  - 暂不强制实现具体脚本逻辑。

---

### 3. 行为保持与兼容性要求

#### 3.1 功能行为保持不变

- 文件夹树：
  - 仍支持显示桌面、文档、下载、图片等常用位置
  - 仍支持显示移动设备（基于 `/Volumes`）
- 图片展示：
  - 保持列表 / 网格两种视图模式及其切换逻辑
  - 保持缩略图自适应布局与虚拟滚动策略（前 100 张）
- 预览功能：
  - 保持左右按钮和键盘方向键切换图片
  - 保持首尾循环浏览逻辑
  - 保持 ESC 关闭预览
  - 保持位置指示器显示“当前位置 / 总数量”
  - 保持底部缩略图轮播及当前图片高亮效果
- 移动设备监听：
  - 保持每 3 秒扫描 `/Volumes` 并更新设备列表

#### 3.2 启动方式兼容

- 保持现有启动方式可用：
  - `uv run python main.py`
- 在此基础上，新增推荐的包式启动方式（可选）：
  - `uv run python -m view_pic` 或通过 `pyproject.toml` 定义入口（后续迭代考虑）

> 本次迭代的最低要求是：**用户现有的启动命令无需改变即可运行重构后的代码。**

---

### 4. 重构实施原则

#### 4.1 渐进式迁移

- 优先目标：
  - 先抽取不涉及复杂 UI 交互的逻辑（如图片扫描、缩略图生成、设备扫描）到 `services` 和 `utils`
  - 再逐步拆分 UI 相关函数到 `core` 模块
- 每次拆分步骤：
  1. 从 `main.py` 中抽取一小块逻辑到新模块
  2. 在新模块中编写对应函数/类
  3. 回到 `main.py` / `app.py` 替换调用
  4. 本地运行回归，确认行为一致

#### 4.2 保持接口清晰

- 模块之间尽量通过明确的函数或类方法交互，不直接操作彼此的内部状态
- `ImageViewerApp` 作为“组装层”，负责持有页面状态（当前文件夹、图片列表、当前索引等）
- `services` 模块主要以“纯函数”或“轻量服务类”的形式存在，方便测试

#### 4.3 编码规范一致

- 延续当前项目编码风格：
  - 使用明确的函数名、方法名（避免单字母命名）
  - 中文文档与注释以简明为主
  - 不引入与现有风格冲突的第三方库

---

## 技术实现方案（概要）

> 详细实现会在《implementation_v3.0.md》中记录，本节仅对拆分策略做概要说明。

### 1. 入口重构

1. 新增 `src/app.py`，将当前 `ImageViewerApp` 类整体迁移到此文件：
   - 保留 `main(self, page: ft.Page)` 方法签名不变
   - 保留所有现有方法（`create_ui`、`display_images`、`show_preview` 等）
2. `main.py` 精简为：
   - 导入 `ImageViewerApp`，创建实例
   - 调用 `ft.run(app.main)`
3. 确认应用在该状态下功能完全正常后，再继续细粒度拆分。

### 2. 服务层拆分

1. 在 `src/services/image_service.py` 中抽取：
   - 图片扫描逻辑（目前在 `load_folder` 中的扩展名过滤等）
   - 缩略图生成逻辑（目前在 `create_thumbnail` 中）
   - 大图加载逻辑（目前在 `show_preview` 中的 Pillow 处理逻辑）
2. 在 `view_pic/services/device_service.py` 中抽取：
   - `update_device_list` 中 `/Volumes` 扫描与异常处理逻辑
   - `start_device_monitoring` 中线程与循环逻辑
3. `ImageViewerApp` 改为调用 `services` 中的方法，自己只保留状态与 UI 控件引用。

### 3. 核心业务层拆分

1. 将文件夹树相关 UI 与逻辑迁移到 `core/file_browser.py`：
   - 构建常用位置分组
   - 创建文件夹项控件
   - 悬停效果处理
2. 将图片列表/网格展示相关逻辑迁移到 `core/image_gallery.py`：
   - `display_images` / `display_grid_view` / `display_list_view`
   - 视图模式切换按钮逻辑
3. 将预览相关逻辑迁移到 `core/preview.py`：
   - 预览对话框和内部布局
   - 位置指示器更新
   - 底部缩略图轮播
   - 键盘事件处理与图片切换

> 拆分过程中，如某些函数跨多个模块均需使用，可进一步下沉到 `utils` 层。

### 4. 配置与工具抽取

1. 将常量、魔法数字迁移至 `config/settings.py`：
   - 窗口尺寸、颜色值、扫描周期（如设备扫描间隔 3 秒）
   - 支持的图片格式列表
2. 将文件系统相关通用逻辑抽取到 `utils/fs_utils.py`：
   - 目录遍历封装
   - 文件大小计算与格式化

---

## 测试与验证

### 1. 手工回归测试

- 在每个拆分阶段，至少执行以下检查：
  - 启动应用是否正常
  - 文件夹树是否正常展示
  - 图片列表/网格是否正常展示
  - 预览功能（左右切换、循环、缩略图轮播）是否正常
  - 键盘快捷键（← → ESC）是否正常
  - 移动设备识别与列表刷新是否正常

### 2. 未来测试规划

- 随着模块拆分完成，可在后续迭代中为 `services` 和 `utils` 层补充单元测试：
  - `tests/test_services/test_image_service.py`
  - `tests/test_services/test_device_service.py`
  - `tests/test_utils/test_fs_utils.py`

---

## 风险与回滚策略

### 1. 潜在风险

- 拆分过程中出现引用错误或循环依赖导致运行失败
- 因迁移不完整导致某些交互细节发生变化

### 2. 风险控制措施

- 每一步拆分后立即本地运行验证
- 优先完成入口拆分与服务层抽取，再拆分 UI 细节
- 保持老逻辑对照，避免一次性重写

### 3. 回滚策略

- 在必要时，可通过 Git 直接回滚到 v2.0 结构（单文件 `main.py`）
- 保留 `implementation_v2.0.md` 作为参考实现文档

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v3.0.0 | 2026-01-11 | 三期需求：项目结构重构与模块化 | AI Assistant |
