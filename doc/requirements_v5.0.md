# View Pic - 模块拆分与日志功能需求文档 v5.0

## 版本信息

- **版本**: v5.0.0  
- **创建日期**: 2026-01-12  
- **迭代主题**: `app.py` 模块拆分优先级规划 & 日志能力接入  
- **基于版本**: v4.0.0

---

## 项目概述

本次迭代（v5.0）在前几期的功能与结构优化基础上，主要解决两个问题：

1. **代码结构问题**：目前大部分核心逻辑仍集中在 [`src/app.py`](src/app.py) 中，而 `src/core/` 目录只有占位文件，没有真实实现，不符合“分层清晰、核心逻辑下沉 core 层”的设计目标。  
2. **可观测性问题**：应用缺少统一的日志能力，出现问题时难以快速定位，需要通过接入标准化的日志系统来记录关键行为与异常信息，日志文件需按“小时”维度进行滚动输出，方便排查与归档。

本期目标：

- 为模块拆分 **制定明确的优先级和边界**，先将“文件夹树 + 图片浏览”相关的核心逻辑下沉到 `core` 层；
- 在不破坏现有功能行为的前提下，**接入基于第三方日志库 `loguru` 的日志能力**，通过 `uv` 管理依赖与运行环境；
- 为未来继续拆分预览、键盘交互等逻辑预留扩展空间。

---

## 五期核心需求

### 1. 模块拆分优先级与范围

#### 1.1 拆分优先级

- **P0 优先拆分模块**：
  - **文件夹浏览（Folder Browser）相关逻辑**：
    - 左侧“常用位置”与“移动设备”区域中，所有与文件夹树构建、子文件夹递归展示、展开/收起状态维护相关的代码；
    - 当前主要集中在 `ImageViewerApp` 中的以下方法：
      - `build_folder_tree`
      - `create_folder_item`
      - `on_folder_hover`
      - `get_subfolders`
      - `has_subfolders`
      - `is_folder_expanded`
      - `toggle_folder_expand`
      - `render_folder_with_children`
  - **图片浏览（Image Gallery）相关逻辑**：
    - 右侧图片区域中，负责根据当前视图模式（网格 / 列表）展示图片列表的逻辑；
    - 当前主要集中在 `ImageViewerApp` 中的以下方法：
      - `display_images`
      - `display_grid_view`
      - `display_list_view`
- **P1 后续可拆分模块（本期只做规划，可不必完全落地）**：
  - 预览对话框与缩略图轮播相关逻辑（`show_preview`、`show_next_image` 等）；
  - 键盘事件处理与图片切换逻辑；
  - 更细粒度的设备相关 UI 逻辑（目前可先维持在 `app.py` 内）。

#### 1.2 拆分后的职责划分

- **`src/app.py`（应用组装层）**：
  - 负责应用入口与页面级配置（窗口大小、主题、事件绑定等）；
  - 持有全局状态：
    - 当前选中文件夹 `current_folder`
    - 当前图片列表 `images`
    - 当前视图模式 `view_mode`
    - 当前预览索引 `current_image_index`
    - 展开文件夹集合 `expanded_folders`
  - 负责将状态和回调传递给 `core` 层，并将 `core` 返回的 Flet 控件组装到页面布局中；
  - 负责调用 `services` 层（如 `image_service`、`device_service`）完成 IO 操作和业务服务调用。

- **`src/core/file_browser.py`（文件夹浏览核心模块）**：
  - 封装与“左侧文件夹树 + 移动设备树”相关的核心逻辑：
    - 构建“常用位置”分组区；
    - 根据状态递归渲染文件夹树（支持无限层级子文件夹）；
    - 维护并使用展开状态集合 `expanded_folders`；
    - 封装获取子文件夹列表、过滤隐藏与系统目录的逻辑；
  - 对 `app.py` 提供清晰接口：
    - 输入：当前状态（当前选中、已展开集合、基础路径等）以及回调（例如选中某文件夹时要调用的函数）；
    - 输出：可直接添加到页面的 Flet 控件（如 `folder_tree`、`device_list` 对应的 `ft.Column`）。

- **`src/core/image_gallery.py`（图片浏览核心模块）**：
  - 封装与“右侧图片区域”相关的展示逻辑：
    - 根据 `view_mode`（`grid` / `list`）决定使用网格或列表展示；
    - 负责网格列数计算、缩略图尺寸控制等布局逻辑；
    - 负责列表模式下文字信息的排版；
  - 对 `app.py` 提供接口：
    - 输入：图片路径列表、当前视图模式、配置常量（如缩略图大小、右侧区域宽度等）、预览回调；
    - 输出：可直接插入到 `image_display` 的 Flet 控件列表。

> 约束：
> - `core` 模块不直接依赖 `ImageViewerApp` 类型，而是通过参数和简单的数据结构交互；
> - 行为保持与当前版本一致，不改变任何已有的用户交互与视觉效果。

---

### 2. 日志功能需求

#### 2.1 日志总体要求

- **技术选型**：
  - 使用第三方日志库 `loguru` 实现日志记录与滚动切分，简化日志调用方式；
  - 通过 `uv` 在 `pyproject.toml` 中增加 `loguru` 依赖，由 `uv sync` 统一管理环境。
- **日志文件组织**：
  - 日志输出目录：`logs/`（位于项目根目录），不存在时自动创建；
  - 日志滚动策略：**按小时维度切分**，即每小时生成一个新的日志文件；
  - 文件命名格式示例：
    - `view_pic_YYYYMMDD_HH.log`（如：`view_pic_20260112_14.log`）；
  - 保留一定数量的历史日志（例如最近 48~72 小时），旧日志自动删除或覆盖（具体数量可在实现时配置常量）。

#### 2.2 日志格式与级别

- **日志行格式**（示例）：
  - `"%(asctime)s [%(levelname)s] %(name)s - %(message)s"`
  - 其中 `asctime` 精确到秒；
- **日志级别**：
  - 默认级别：`INFO`；
  - 支持输出 `DEBUG`、`INFO`、`WARNING`、`ERROR`、`CRITICAL`；
  - 开发阶段可以通过环境变量或配置开关将级别调整为 `DEBUG`。

#### 2.3 日志配置位置

- 新增统一的日志配置模块，例如：
  - `src/config/logging_config.py`：
    - 提供 `setup_logging()` 函数，在应用启动时调用一次；
    - 内部使用 `loguru` 配置按小时轮转的日志文件（文件路径、轮转周期、保留数量等）；
    - 将 `loguru` 的日志输出与标准输出进行适配（如有需要，可将标准库 `logging` 重定向到 `loguru`）。
- `main.py` 或 `ImageViewerApp.main` 在初始化时调用 `setup_logging()`，确保后续模块可以直接使用 `loguru` 的 `logger` 记录日志。

#### 2.4 关键打点位置

- **应用生命周期**：
  - 应用启动时记录一条 `INFO` 级日志（包含版本号、运行环境信息等）；
  - 应用正常退出或异常退出时记录对应日志。
- **文件夹与图片浏览**：
  - 用户点击文件夹时：记录选中的文件夹路径、图片数量（加载后）；
  - 加载图片失败、无权限访问、未找到图片等情况记录 `WARNING` 或 `ERROR`；
  - 切换视图模式（列表/网格）时记录操作行为和当前图片数量。
- **设备相关**：
  - 设备监控线程启动和停止；
  - 检测到新设备挂载或设备移除时记录事件（设备名称、路径等）。
- **异常捕获**：
  - 当前代码中已有的 `try/except` 块（如加载文件夹失败时）应改为使用 `logger.exception` 或 `logger.error`（`logger` 来自 `loguru`），替代 `print` 输出。

---

## 技术实现方案（概要）

### 1. 模块拆分实施步骤

1. **创建 `core` 模块文件**：
   - 新建 `src/core/file_browser.py`；
   - 新建 `src/core/image_gallery.py`；
   - 两个文件均通过 `__all__` 或显式函数导出来暴露主要接口。
2. **抽取文件夹浏览逻辑到 `core/file_browser.py`**：
   - 定义必要的数据结构和函数签名，例如：
     - `build_folder_tree(...)`：构建常用位置与设备区的完整控件树；
     - `render_folder_with_children(...)`、`get_subfolders(...)` 等内部辅助函数；
   - 从 `ImageViewerApp` 中迁出 `build_folder_tree` 等相关方法，将其中与 UI 构建有关的部分封装到 `core`；
   - `app.py` 中保留最少的 glue 逻辑，负责：
     - 准备状态参数（当前选中、展开集合等）；
     - 提供文件夹选中回调（调用 `load_folder`）。
3. **抽取图片浏览逻辑到 `core/image_gallery.py`**：
   - 定义如 `build_image_gallery(...)` 等函数，根据图片列表和视图模式返回控件列表；
   - 将 `display_images`、`display_grid_view`、`display_list_view` 中的布局逻辑迁移到 `core`；
   - `app.py` 中只负责：
     - 维护 `images`、`view_mode` 状态；
     - 调用 `core.image_gallery` 构建控件并插入 `image_display`。
4. **行为回归验证**：
   - 每完成一小步迁移后，本地运行应用，验证：
     - 左侧文件夹树展示与展开/收起行为是否与迁移前一致；
     - 右侧图片列表/网格展示是否正常；
     - 预览、键盘交互、设备监控等功能不受影响。

### 2. 日志接入实施步骤

1. **新增日志配置模块**：
   - 在 `src/config/` 下新增 `logging_config.py`，实现：
     - 创建 `logs/` 目录；
     - 配置 `TimedRotatingFileHandler`（按小时轮转，设置备份数量）；
     - 配置日志格式、根 logger 级别；
     - 暴露 `setup_logging()` 函数。
2. **在应用启动时初始化日志**：
   - 在 `main.py` 或 `ImageViewerApp.main` 中调用 `setup_logging()`；
   - 确保在其他模块导入 logger 之前完成初始化。
3. **替换现有 `print` 调试输出**：
   - 将 `print` 调用替换为 `logging`：
     - 一般信息使用 `logger.info`；
     - 出错信息使用 `logger.error` 或 `logger.exception`（保留堆栈）。
4. **关键路径增加日志打点**：
   - 在文件夹点击、图片加载、视图切换、设备变化等关键操作中增加日志；
   - 避免过度日志导致性能下降或日志文件膨胀。

---

## 实现优先级

- **P0（本期必须完成）**：
  1. 根据本需求文档拆分文件夹浏览与图片浏览逻辑到 `core/file_browser.py` 与 `core/image_gallery.py`；
  2. 接入基于 `loguru` 的按小时滚动日志能力，确保关键路径有合理日志输出；
  3. 运行回归验证，确保功能行为与现有版本一致。

- **P1（建议本期或后续尽快完成）**：
  1. 对日志目录与保留数量进行配置化（可放入 `settings.py`）；
  2. 进一步将预览相关逻辑拆分到 `core` 模块。

- **P2（后续可选优化）**：
  1. 如有需要，将标准库 `logging` 与 `loguru` 做更深度的兼容处理（例如将第三方库日志统一汇聚到 `loguru`）；
  2. 为 `core` 模块中与文件系统相关的函数编写单元测试。

---

## 测试与验收

- **功能验收**：
  - 常用位置与移动设备区域展示正确，文件夹展开/收起行为正常；
  - 选中任意文件夹时，右侧图片区域展示与迁移前保持一致；
  - 视图模式切换、预览与设备监控功能无回退；
  - 日志文件按小时生成，内容包含关键操作与错误信息。
- **结构验收**：
  - `src/core/file_browser.py` 与 `src/core/image_gallery.py` 中存在实际实现代码，不再是空壳；
  - `src/app.py` 体量明显减小，角色主要为“应用组装层”；
  - 所有新逻辑均通过 `uv run python main.py` 的方式可正常运行。

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v5.0.0 | 2026-01-12 | 五期需求：模块拆分优先级规划与日志能力接入 | AI Assistant |
