# View Pic - 文件夹树形展示需求文档 v4.0

## 版本信息

**版本**: v4.0.0  
**创建日期**: 2026-01-11  
**迭代主题**: 文件夹树形结构展示与交互优化  
**基于版本**: v3.0.0

---

## 项目概述

本次迭代（v4.0）主要聚焦于优化左侧文件夹区域的展示和交互功能，引入树形结构展示，支持文件夹的展开/收起操作，实现嵌套子文件夹的浏览能力。在 v3.0 项目结构重构的基础上，提升文件浏览的灵活性和深度。

**现状**：
- 当前左侧文件夹树仅显示一级固定路径（桌面、文档、图片、下载）和移动设备
- 无法展开查看子文件夹
- 用户只能点击一级目录查看图片
- 对于多层级的文件夹结构，用户需要在文件管理器中打开后才能查看

**问题**：
- 缺乏文件夹层级展示，导航不够灵活
- 无法快速浏览深层次的文件夹结构
- 用户体验不够友好，操作路径较长

**目标**：
- 实现树形结构展示，支持文件夹的展开/收起
- 支持无限层级的子文件夹嵌套
- 点击文件夹实时更新右侧图片列表
- 保持界面美观简约，符合现代设计规范

---

## 四期核心需求

### 1. 文件夹树形结构展示

#### 1.1 展开/收起箭头
- **需求描述**: 每个文件夹左侧显示一个小箭头，用于展开/收起子文件夹
- **功能点**:
  - **箭头图标**: 
    - 收起状态: 使用右箭头 `▶` 或 `chevron_right` 图标
    - 展开状态: 使用下箭头 `▼` 或 `expand_more` 图标
  - **交互行为**:
    - 点击箭头：展开/收起当前文件夹的子文件夹列表
    - 点击文件夹名称：加载该文件夹下的图片到右侧区域
    - 展开时自动扫描并显示子文件夹
    - 收起时隐藏所有子文件夹（包括孙文件夹）
  - **视觉效果**:
    - 箭头与文件夹名称对齐
    - 箭头大小适中，清晰可见
    - 点击时有旋转动画（可选优化）
  - **层级策略**:
    - **第一级文件夹**：保留扁平结构（常用位置、移动设备），左侧箭头可选显示
    - **二级及以下**：采用树形结构，带缩进和箭头
    - 此混合策略既保持美观，又提供深度浏览能力
- **用户价值**: 
  - 清晰的视觉提示，用户一目了然
  - 直观的交互方式，符合用户习惯
  - 避免第一级过于拥挤，保持简洁美观

#### 1.2 子文件夹嵌套展示
- **需求描述**: 支持无限层级的子文件夹嵌套显示
- **功能点**:
  - **层级缩进**: 
    - 每深入一级，向右缩进 20-30px
    - 使用视觉引导线或缩进空白区分层级
  - **递归展开**:
    - 子文件夹同样支持展开/收起操作
    - 孙文件夹、曾孙文件夹等均可递归展开
    - 无深度限制，理论上支持任意层级
  - **性能优化**:
    - 按需加载子文件夹，只在展开时扫描
    - 收起后清空子节点，减少内存占用
- **用户价值**: 
  - 完整的文件夹结构浏览能力
  - 灵活的导航方式，无需离开应用

#### 1.3 当前选中状态
- **需求描述**: 明确显示当前选中的文件夹
- **功能点**:
  - **高亮效果**:
    - 选中的文件夹背景色高亮（如 `#E3F2FD` 浅蓝色）
    - 文本加粗或颜色变化（如 `#1976D2` 深蓝色）
  - **单选机制**:
    - 同一时间只能有一个文件夹处于选中状态
    - 点击其他文件夹时，自动取消前一个选中状态
  - **持久化显示**:
    - 选中状态不因展开/收起操作而消失
    - 右侧图片列表始终对应当前选中的文件夹
- **用户价值**: 
  - 清晰的位置感，用户知道当前浏览的位置
  - 避免迷失在多层级结构中

---

### 2. 实时图片列表更新

#### 2.1 点击文件夹触发更新
- **需求描述**: 点击任意文件夹时，右侧立即显示该文件夹下的图片
- **功能点**:
  - **触发时机**: 点击文件夹名称或图标（不包括箭头）
  - **加载逻辑**:
    - 扫描选中文件夹下的所有符合格式的图片
    - 支持格式: `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`, `.webp`（可配置）
    - 过滤非图片文件
  - **空状态处理**:
    - 如果文件夹中没有图片，显示提示信息："此文件夹中没有图片"
    - 显示当前文件夹路径，方便用户确认位置
  - **错误处理**:
    - 如果文件夹无权限访问，显示友好提示
    - 不中断整体操作，用户可以继续点击其他文件夹
- **用户价值**: 
  - 即时反馈，无需等待
  - 流畅的浏览体验

#### 2.2 视图模式保持
- **需求描述**: 切换文件夹时，保持当前的视图模式（网格/列表）
- **功能点**:
  - 加载新文件夹图片时，延续当前视图模式
  - 用户无需重新选择视图模式
- **用户价值**: 
  - 减少重复操作
  - 保持一致的浏览体验

---

### 3. 树形结构数据模型

#### 3.1 文件夹节点定义
- **数据结构**:
```python
class FolderNode:
    path: Path              # 文件夹路径
    name: str               # 显示名称
    icon: str               # 图标类型
    children: List[FolderNode] | None  # 子文件夹列表（懒加载）
    is_expanded: bool       # 是否展开
    has_children: bool      # 是否有子文件夹
```

#### 3.2 懒加载策略
- **实现方式**:
  - 初始化时仅加载一级文件夹（常用位置）
  - 点击展开箭头时，实时扫描子文件夹
  - 收起时保留子文件夹数据（可选：清空以节省内存）
- **性能考虑**:
  - 避免一次性加载整个文件系统树
  - 对于包含大量子文件夹的目录，采用异步加载（可选优化）

---

### 4. UI 设计规范

#### 4.1 文件夹项布局

**方案A：混合策略（推荐）**
```
┌────────────────────────────────────┐
│  常用位置                          │
│  [📁] 桌面                        │  ← 一级文件夹（扁平，可选箭头）
│    [▶] [📁] 子文件夹1            │  ← 二级文件夹（树形，有箭头+缩进）
│    [▼] [📁] 子文件夹2            │  ← 二级文件夹（展开）
│      [▶] [📁] 孙文件夹1         │  ← 三级文件夹（缩进2层）
│      [▶] [📁] 孙文件夹2         │  ← 三级文件夹（缩进2层）
│  [📁] 文档                        │  ← 一级文件夹（扁平）
│  [📁] 图片                        │  ← 一级文件夹（扁平）
│                                    │
│  移动设备                          │
│  [📁] iPhone                      │  ← 一级设备（扁平）
└────────────────────────────────────┘
```

**方案B：完全树形（备选）**
```
┌────────────────────────────────────┐
│  常用位置                          │
│  [▶] [📁] 桌面                    │  ← 一级文件夹（树形）
│  [▼] [📁] 文档                    │  ← 一级文件夹（展开）
│    [▶] [📁] 子文件夹1            │  ← 二级文件夹（缩进1层）
│    [▼] [📁] 子文件夹2            │  ← 二级文件夹（展开）
│      [▶] [📁] 孙文件夹1         │  ← 三级文件夹（缩进2层）
│  [▶] [📁] 图片                    │  ← 一级文件夹（树形）
└────────────────────────────────────┘
```

**说明**：
- 默认采用**方案A（混合策略）**，第一级保持简洁扁平
- 实现过程中可通过配置切换到**方案B（完全树形）**
- 根据实际效果评估，选择最优方案

#### 4.2 色彩方案（继承 v3.0）
- **主色**: `#1976D2` (深蓝色)
- **辅助色**: `#E3F2FD` (浅蓝色背景)
- **悬停色**: `#F5F5F5` (浅灰色)
- **选中色**: `#E3F2FD` (浅蓝色背景) + 文字 `#1976D2`
- **箭头色**: `#666666` (中灰色)

#### 4.3 尺寸与间距
- **文件夹项高度**: `40px`
- **箭头图标大小**: `16px`
- **文件夹图标大小**: `20px`
- **层级缩进**: `24px` (每层)
- **左侧面板宽度**: `280px` (保持不变)
- **滚动条样式**: 自动显示，样式简洁

#### 4.4 交互效果
- **悬停效果**: 
  - 文件夹项背景色变为 `#F5F5F5`
  - 鼠标指针变为 `pointer`
- **点击反馈**:
  - 箭头点击时有轻微的旋转动画（90度，150ms，可选）
  - 文件夹展开/收起时有淡入淡出效果（可选）
- **选中效果**:
  - 背景色高亮 `#E3F2FD`
  - 文字加粗，颜色变为 `#1976D2`

---

## 技术实现方案

### 1. 文件夹树组件重构

#### 实现要点
- **混合策略**：第一级文件夹保持扁平结构，二级及以下采用树形结构
- 使用递归组件渲染子文件夹（从第二级开始）
- 维护文件夹展开状态（存储在 `ImageViewerApp` 中）
- 第一级文件夹左侧可选显示箭头（有子文件夹时显示）

#### 关键方法
```python
def create_folder_tree_item(
    self, 
    folder_path: Path, 
    name: str, 
    icon, 
    level: int = 0
) -> ft.Container:
    """创建树形文件夹项"""
    # 检查是否有子文件夹
    has_children = self.has_subfolders(folder_path)
    is_expanded = self.is_folder_expanded(folder_path)
    
    # 展开/收起箭头
    expand_icon = ft.IconButton(
        icon=ft.icons.EXPAND_MORE if is_expanded else ft.icons.CHEVRON_RIGHT,
        icon_size=16,
        on_click=lambda e: self.toggle_folder_expand(folder_path),
        visible=has_children,
    )
    
    # 文件夹项
    folder_item = ft.Row([
        ft.Container(width=24 * level),  # 层级缩进
        expand_icon,
        ft.Icon(icon, size=20, color="#1976D2"),
        ft.Text(name, size=14),
    ])
    
    return ft.Container(content=folder_item, ...)
```

### 2. 展开/收起逻辑

#### 状态管理
```python
class ImageViewerApp:
    def __init__(self):
        # 存储展开的文件夹路径集合
        self.expanded_folders: Set[Path] = set()
        
    def toggle_folder_expand(self, folder_path: Path):
        """切换文件夹展开状态"""
        if folder_path in self.expanded_folders:
            self.expanded_folders.remove(folder_path)
        else:
            self.expanded_folders.add(folder_path)
        self.rebuild_folder_tree()
```

#### 子文件夹扫描
```python
def get_subfolders(self, parent_path: Path) -> List[Path]:
    """获取子文件夹列表"""
    try:
        return [
            item for item in parent_path.iterdir()
            if item.is_dir() and not item.name.startswith('.')
        ]
    except PermissionError:
        return []
```

### 3. 递归渲染

#### 实现方式
```python
def render_folder_tree(
    self, 
    folder_path: Path, 
    name: str, 
    icon, 
    level: int = 0
) -> List[ft.Control]:
    """递归渲染文件夹树"""
    controls = []
    
    # 添加当前文件夹项
    controls.append(
        self.create_folder_tree_item(folder_path, name, icon, level)
    )
    
    # 如果展开，递归渲染子文件夹
    if self.is_folder_expanded(folder_path):
        subfolders = self.get_subfolders(folder_path)
        for subfolder in subfolders:
            controls.extend(
                self.render_folder_tree(
                    subfolder, 
                    subfolder.name, 
                    ft.icons.FOLDER_OUTLINED, 
                    level + 1
                )
            )
    
    return controls
```

---

## 用户体验优化

### 1. 性能优化
- **懒加载**: 仅在展开时扫描子文件夹
- **节流**: 避免频繁重建树形结构
- **虚拟滚动**: 文件夹数量过多时，考虑虚拟列表（v4.1 优化）

### 2. 视觉反馈
- **加载状态**: 扫描子文件夹时显示加载提示（可选）
- **动画效果**: 展开/收起时平滑过渡
- **清晰层级**: 通过缩进和连接线明确父子关系

### 3. 错误处理
- **权限问题**: 友好提示无法访问的文件夹
- **空文件夹**: 显示"无子文件夹"提示
- **不中断**: 个别文件夹错误不影响整体浏览

---

## 测试计划

### 功能测试
1. ✅ 测试展开/收起箭头功能
2. ✅ 测试多层级嵌套展示
3. ✅ 测试点击文件夹加载图片
4. ✅ 测试当前选中状态高亮
5. ✅ 测试空文件夹提示
6. ✅ 测试权限错误处理

### 边界测试
1. ✅ 测试深层级文件夹（10层以上）
2. ✅ 测试大量子文件夹（100+）
3. ✅ 测试文件名过长的显示
4. ✅ 测试特殊字符文件夹名
5. ✅ 测试系统隐藏文件夹

### 性能测试
1. ✅ 测试展开大量文件夹时的响应速度
2. ✅ 测试频繁展开/收起的性能
3. ✅ 测试内存占用情况

### 兼容性测试
1. ✅ 验证在 macOS 上的显示效果
2. ✅ 验证在不同窗口尺寸下的滚动

---

## 实现优先级

### P0 (必须实现)
1. 展开/收起箭头功能
2. 子文件夹嵌套显示
3. 点击文件夹实时更新图片列表
4. 当前选中状态高亮

### P1 (高优先级)
1. 层级缩进视觉效果
2. 懒加载子文件夹
3. 错误处理和友好提示

### P2 (可选优化)
1. 展开/收起动画效果
2. 层级连接线
3. 右键菜单（在文件管理器中打开）

---

## 风险与限制

### 潜在风险
1. **性能问题**: 文件夹层级过深或数量过多时可能卡顿
   - **解决方案**: 懒加载 + 虚拟滚动（v4.1 优化）
2. **权限问题**: 系统文件夹可能无权限访问
   - **解决方案**: 捕获异常并友好提示
3. **UI 复杂度**: 递归渲染可能导致组件嵌套过深
   - **解决方案**: 优化组件结构，使用扁平化数据模型

### 已知限制
1. 当前版本不支持文件夹拖拽排序
2. 不支持收藏夹/书签功能
3. 不支持文件夹搜索（v4.2 规划）

---

## 后续版本规划

### v4.1 版本计划
- [ ] 虚拟滚动优化，支持海量文件夹
- [ ] 文件夹搜索功能
- [ ] 右键菜单（在文件管理器中打开、刷新等）
- [ ] 收藏夹功能，快速访问常用文件夹

### v4.2 版本计划
- [ ] 文件夹拖拽排序
- [ ] 文件夹重命名/删除（高级功能）
- [ ] 文件夹属性查看（子文件夹数量、图片数量等）
- [ ] 面包屑导航，快速跳转到父级文件夹

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v4.0.0 | 2026-01-11 | 四期需求：文件夹树形展示与交互优化 | AI Assistant |

---

**备注**: 
- 本文档基于 v3.0 需求文档编写
- 所有功能均为增量更新，不影响 v3.0 已有功能
- 实现过程中如有调整，将及时更新本文档
- 设计参考了 macOS Finder 和 Windows 资源管理器的树形结构
